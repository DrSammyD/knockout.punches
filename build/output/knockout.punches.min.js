/*
 Knockout.Punches
 Enhanced binding syntaxes for Knockout 3+
 (c) Michael Best
 License: MIT (http://www.opensource.org/licenses/mit-license.php)
 Version 0.5.1
*/
(function(c){if("function"===typeof define&&define.amd)define(["knockout"],c);else if("object"===typeof module){var m=require("knockout");c(m)}else c(window.ko)})(function(c){function m(a,b){return x(D(a),"preprocess",b)}function D(a){return"object"===typeof a?a:c.getBindingHandler(a)||(c.bindingHandlers[a]={})}function x(a,b,d){if(a[b]){var f=a[b];a[b]=function(a,b,c){if(a=f.call(this,a,b,c))return d.call(this,a,b,c)}}else a[b]=d;return a}function t(a){var b=c.bindingProvider.instance;if(b.preprocessNode){var d=
b.preprocessNode;b.preprocessNode=function(b){var c=d.call(this,b);c||(c=a.call(this,b));return c}}else b.preprocessNode=a}function E(a,b){var d=c.getBindingHandler;c.getBindingHandler=function(f){var c;return d(f)||(c=f.match(a))&&b(c,f)}}function y(a){if(-1===a.indexOf("|"))return a;var b=a.match(/"([^"\\]|\\.)*"|'([^'\\]|\\.)*'|\|\||[|:]|[^\s|:"'][^|:"']*[^\s|:"']|[^\s|:"']/g);if(b&&1<b.length){b.push("|");a=b[0];for(var d,c,e=!1,g=!1,h=1;c=b[h];++h)"|"===c?(e&&(":"===d&&(a+="undefined"),a+=")"),
e=g=!0):(g?a="ko.filters['"+c+"']("+a:e&&":"===c?(":"===d&&(a+="undefined"),a+=","):a+=c,g=!1),d=c}return a}function z(a){m(a,y)}function A(a,b,d){function f(d){e[d]&&(e[d]=function(f,e){var k=Array.prototype.slice.call(arguments,0);k[1]=function(){var b={};b[a]=e();return b};return c.bindingHandlers[b][d].apply(this,k)})}var e=c.utils.extend({},this);f("init");f("update");e.preprocess&&(e.preprocess=null);c.virtualElements.allowedBindings[b]&&(c.virtualElements.allowedBindings[d]=!0);return e}function u(a,
b){var d=c.getBindingHandler(a);if(d){var f=d.getNamespacedHandler||A;d.getNamespacedHandler=function(){return m(f.apply(this,arguments),b)}}}function F(a,b,d){if("{"!==a.charAt(0))return a;a=c.expressionRewriting.parseObjectLiteral(a);c.utils.arrayForEach(a,function(a){d(b+G+a.key,a.value)})}function r(a){m(a,F)}function q(a){return/^([$_a-z][$\w]*|.+(\.\s*[$_a-z][$\w]*|\[.+\]))$/i.test(a)?"function(_x,_y,_z){return("+a+")(_x,_y,_z);}":a}function v(a){m(a,q)}function s(a,b,d){a=D(a);a._propertyPreprocessors||
(x(a,"preprocess",O),a._propertyPreprocessors={});x(a._propertyPreprocessors,b,d)}function O(a,b,d){if("{"!==a.charAt(0))return a;a=c.expressionRewriting.parseObjectLiteral(a);var f=[],e=this._propertyPreprocessors||{};c.utils.arrayForEach(a,function(a){var b=a.key;a=a.value;e[b]&&(a=e[b](a,b,d));a&&f.push("'"+b+"':"+a)});return"{"+f.join(",")+"}"}function B(a){return function(b){return"function("+a+"){return("+b+");}"}}function H(a,b,d,c){function e(a){var c=a.match(/^([\s\S]*)}}([\s\S]*?)\{\{([\s\S]*)$/);
c?(e(c[1]),b(c[2]),d(c[3])):d(a)}if(a=a.match(/^([\s\S]*?)\{\{([\s\S]*)}}([\s\S]*)$/))b(a[1]),e(a[2]),b(a[3]);else for(var g=c,h=[c],l=!0;(h.push(g=g.nextSibling),g)&&l;)if(3===g.nodeType&&g.nodeValue&&~g.nodeValue.indexOf("}}")&&"TEXTAREA"!=(g.parentNode||{}).nodeName){l=!1;middle=h.slice(1,-1);h=[];h.push(c.nodeValue);for(var k=0;k<middle.length;k++)h.push(middle[k].outerHTML);h.push(g.nodeValue);a=h.join("");if(a=a.match(/^([\s\S]*?)\{\{([\s\S]*)}}([\s\S]*)$/)){for(k=middle.length-1;0<=k;k--)c.parentElement.removeChild(middle[k]);
c.parentElement.removeChild(g);b(a[1]);e(a[2]);b(a[3])}}}function w(a){return null==a?"":a.trim?a.trim():a.toString().replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")}function I(a){if(3===a.nodeType&&a.nodeValue&&-1!==a.nodeValue.indexOf("{{")&&"TEXTAREA"!=(a.parentNode||{}).nodeName){var b=[];H(a.nodeValue,function(a){a&&b.push(document.createTextNode(a))},function(c){c&&b.push.apply(b,P.wrapExpression(c,a))},a);if(b.length){if(a.parentNode){for(var c=0,f=b.length,e=a.parentNode;c<f;++c)e.insertBefore(b[c],
a);e.removeChild(a)}return b}}}function J(){t(I)}function K(a){if(1===a.nodeType&&a.attributes.length)for(var b=a.getAttribute(C),d=c.utils.arrayPushAll([],a.attributes),f=d.length,e=0;e<f;++e){var g=d[e];if(g.specified&&g.name!=C&&-1!==g.value.indexOf("{{")){var h=[],l="";H(g.value,function(a){a&&h.push('"'+a.replace(/"/g,'\\"')+'"')},function(a){a&&(l=a,h.push("ko.unwrap("+a+")"))});1<h.length&&(l='""+'+h.join("+"));if(l){var k=g.name.toLowerCase(),k=Q.attributeBinding(k,l,a)||L(k,l,a),b=b?b+(","+
k):k;a.setAttribute(C,b);a.removeAttribute(g.name)}}}}function L(a,b,d){return c.getBindingHandler(a)?a+":"+b:"attr."+a+":"+b}function M(){t(K)}var p=c.unwrap,n=c.punches={utils:{addBindingPreprocessor:m,addNodePreprocessor:t,addBindingHandlerCreator:E,setBindingPreprocessor:m,setNodePreprocessor:t}};n.enableAll=function(){J();M();r("attr");r("css");r("event");r("style");c.bindingHandlers.checked.after.push("attr.value");z("text");z("html");u("attr",y);v("click");v("submit");v("optionsAfterRender");
u("event",q);s("template","beforeRemove",q);s("template","afterAdd",q);s("template","afterRender",q)};c.filters={uppercase:function(a){return String.prototype.toUpperCase.call(p(a))},lowercase:function(a){return String.prototype.toLowerCase.call(p(a))},"default":function(a,b){a=p(a);return"function"===typeof a?a:"string"===typeof a?""===w(a)?b:a:null==a||0==a.length?b:a},replace:function(a,b,c){return String.prototype.replace.call(p(a),b,c)},fit:function(a,b,c,f){a=p(a);if(b&&(""+a).length>b)switch(c=
""+(c||"..."),b-=c.length,a=""+a,f){case "left":return c+a.slice(-b);case "middle":return f=Math.ceil(b/2),a.substr(0,f)+c+a.slice(f-b);default:return a.substr(0,b)+c}else return a},json:function(a,b,d){return c.toJSON(a,d,b)},number:function(a){return(+p(a)).toLocaleString()}};n.textFilter={preprocessor:y,enableForBinding:z};var G=".";E(/([^\.]+)\.(.+)/,function(a,b){var d=a[1],f=c.bindingHandlers[d];if(f)return d=(f.getNamespacedHandler||A).call(f,a[2],d,b),c.bindingHandlers[b]=d});n.namespacedBinding=
{defaultGetHandler:A,setDefaultBindingPreprocessor:u,addDefaultBindingPreprocessor:u,preprocessor:F,enableForBinding:r};n.wrappedCallback={preprocessor:q,enableForBinding:v};n.preprocessBindingProperty={setPreprocessor:s,addPreprocessor:s};var N=B("$data,$event");n.expressionCallback={makePreprocessor:B,eventPreprocessor:N,enableForBinding:function(a,b){b=Array.prototype.slice.call(arguments,1).join();m(a,B(b))}};c.bindingHandlers.on={getNamespacedHandler:function(a){a=c.getBindingHandler("event"+
G+a);return m(a,N)}};if(!c.virtualElements.allowedBindings.html){var R=c.bindingHandlers.html.update;c.bindingHandlers.html.update=function(a,b){if(8===a.nodeType){var d=p(b());null!=d?(d=c.utils.parseHtmlFragment(""+d),c.virtualElements.setDomNodeChildren(a,d)):c.virtualElements.emptyNode(a)}else R(a,b)};c.virtualElements.allowedBindings.html=!0}var P=n.interpolationMarkup={preprocessor:I,enable:J,wrapExpression:function(a,b){var c=b?b.ownerDocument:document,f=!0,e;a=w(a);var g=a[0],h=a[a.length-
1],l=[];if("#"===g){if("/"===h?e=a.slice(1,-1):(e=a.slice(1),f=!1),g=e.match(/^([^,"'{}()\/:[\]\s]+)\s+([^\s:].*)/))e=g[1]+":"+g[2]}else"/"!==g&&(e="{"===g&&"}"===h?"html:"+w(a.slice(1,-1)):"text:"+w(a));e&&l.push(c.createComment("ko "+e));f&&l.push(c.createComment("/ko"));return l}},C="data-bind",Q=n.attributeInterpolationMarkup={preprocessor:K,enable:M,attributeBinding:L};return n});
